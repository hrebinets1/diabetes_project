{% load static %}
<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>Patient Dashboard</title>
    <link rel="stylesheet" href="{% static 'diabetes/css/base.css' %}">
    <link rel="stylesheet" href="{% static 'diabetes/css/dashboard.css' %}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@3.6.0/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
</head>

<body>
    <div class="header-container">
        <div>
            <h1>Вітаємо, {{ user.first_name }}!</h1>
            <small>Лікарня: {{ user.hospital }} | Лікар: {{ user.medic }}</small>
        </div>
        <div>
            <span>{{user.username}}</span>
            <a href="{% url 'logout' %}" class="button" style="padding: 10px 20px; min-width: auto;">Вийти</a>
        </div>
    </div>

<!--    {% if messages %}-->
<!--    <div class="header-container">-->
<!--        <div class="for-messages">-->
<!--            <ul>-->
<!--                {% for message in messages %}-->
<!--                <li>{{ message }}</li>-->
<!--                {% endfor %}-->
<!--            </ul>-->
<!--        </div>-->
<!--    </div>-->
<!--    {% endif %}-->

    <div class="dashboard-grid">

        <div class="left-col">
            <div class="metrics-card" style="margin-bottom: 20px;">
                <h4>Поточний рівень</h4>
                <div class="big-number" style="color: {% if current_level > 10 %}#e74c3c{% else %}#27ae60{% endif %}">
                    {{ current_level }}
                </div>
                <small>mmol/L</small>
            </div>

            <div class="input-section">
                <h3>Новий запис</h3>
                <form method="POST">
                    {% csrf_token %}
                    {{ form.as_p }}
                    <button type="submit" class="button" style="width: 100%;">Зберегти</button>
                </form>
            </div>
        </div>

        <div class="right-col">
            <div class="stats-panel">
                <div class="metrics-card">
                    <h4>Середній</h4>
                    <div class="big-number">{{ avg|default:"-" }}</div>
                </div>
                <div class="metrics-card">
                    <h4>Мін</h4>
                    <div class="big-number">{{ min|default:"-" }}</div>
                </div>
                <div class="metrics-card">
                    <h4>Макс</h4>
                    <div class="big-number">{{ max|default:"-" }}</div>
                </div>
                <div class="metrics-card">
                    <h4>HbA1c (est)</h4>
                    <div class="big-number">{{ hba1c|default:"-" }}%</div>
                </div>
            </div>

            <div class="chart-wrapper">
                <div class="chart-controls">
                    <span>Період: </span>
                    <a href="?period=week" class="{% if period == 'week' %}active{% endif %}">Тиждень</a>
                    <a href="?period=month" class="{% if period == 'month' %}active{% endif %}">Місяць</a>
                    <a href="?period=3months" class="{% if period == '3months' %}active{% endif %}">3 Місяці</a>
                    <a href="?period=year" class="{% if period == 'year' %}active{% endif %}">Рік</a>
                </div>
                <div style="height: 400px; width: 100%;">
                    <canvas id="glucoseChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        const historyData = JSON.parse('{{ history_data|default:"[]"|escapejs }}');

        const ctx = document.getElementById('glucoseChart').getContext('2d');
        const gradient = ctx.createLinearGradient(0, 0, 0, 400);
        gradient.addColorStop(0.4, 'rgba(255, 100, 100, 0.5)'); // Високий
        gradient.addColorStop(0.7, 'rgba(50, 200, 250, 0.5)'); // Норма
        gradient.addColorStop(1, 'rgba(255, 200, 70, 0.5)'); // Низький

        new Chart(ctx, {
            type: 'line',
            data: {
                datasets: [{
                        label: 'Історія (mmol/L)',
                        data: historyData,
                        backgroundColor: gradient,
                        fill: true,
                        tension: 0.3,
                        pointRadius: historyData.length > 50 ? 0 : 3,
                        parsing: {
                            xAxisKey: 'x',
                            yAxisKey: 'y'
                        }
                    },

                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: '{{ period }}' === 'year' ? 'month' : 'day',
                            displayFormats: { day: 'dd.MM', month: 'MMM yyyy', hour: 'HH:mm' },
                            tooltipFormat: 'dd.MM.yyyy HH:mm'
                        },
                        title: { display: true, text: 'Час' }
                    },
                    y: {
                        beginAtZero: false,
                        suggestedMin: 3,
                        suggestedMax: 15
                    }
                },
                interaction: {
                    mode: 'nearest',
                    axis: 'x',
                    intersect: false
                }
            }
        });
    </script>
</body>
</html>